{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Управление — {{ game.title }}</title>
  <style>body{font-family:Arial,Helvetica,sans-serif;margin:20px} .round{margin-bottom:16px;padding:10px;border:1px solid #eee} .question{padding:8px;border-top:1px dashed #ddd} .ratings{margin-top:12px}</style>
  <script>
    function sendQuestion(formId){ document.getElementById(formId).submit(); }
    function stopAnswers(formId){ document.getElementById(formId).submit(); }
  </script>
</head>
<body>
  <h1>Управление игрой: {{ game.title }}</h1>
  <a href="{% url 'admin:index' %}">Админка Django</a>

  <div>
    {% for rnd in rounds %}
      <div class="round">
        <strong>Раунд {{ rnd.order }} — {{ rnd.title }}</strong>
        <div>{{ rnd.description }}</div>
        {% for q in rnd.questions.all %}
          <div class="question">
            <div><strong>Вопрос {{ q.id }}:</strong> {{ q.text|truncatechars:200 }}</div>
            <form id="send_q_{{ q.id }}" method="post" action="{% url 'admin_panel:send_question' game.id q.id %}">
              {% csrf_token %}
              <label>Длительность (сек): <input type="number" name="duration" value="30" min="5"></label>
              <button type="button" onclick="sendQuestion('send_q_{{ q.id }}')">Отправить игрокам</button>
            </form>
          </div>
        {% endfor %}
      </div>
    {% endfor %}
  </div>

  <div style="margin-top:18px">
    <form id="stop_answers_form" method="post" action="{% url 'admin_panel:stop_answers' game.id %}">{% csrf_token %}<button type="button" onclick="stopAnswers('stop_answers_form')">Остановить приём ответов</button></form>
  </div>

  <div class="ratings">
    <h3>Рейтинг</h3>
    <ul>
      {% for r in ratings %}
        <li>{{ r.participant.team_name|default:r.participant.session_key }} — {{ r.score }}</li>
      {% empty %}
        <li>Нет участников</li>
      {% endfor %}
    </ul>
  </div>

  <div style="margin-top:16px">
    <h3>Превью игрока</h3>
    <iframe src="/stream/{{ game.id }}/" style="width:100%;height:360px;border:1px solid #ddd"></iframe>
  </div>

  <div style="margin-top:12px">
    <a href="{% url 'admin_panel:moderate_answers' game.id %}">Модерировать ответы</a>
  </div>

  <script>
    // open WebSocket to listen for rating updates and update the list live
    (function(){
      const ws = new WebSocket((location.protocol === 'https:' ? 'wss' : 'ws') + '://' + location.host + '/ws/game/{{ game.id }}/');
      ws.onmessage = (e) => {
        try{
          const d = JSON.parse(e.data);
          if (d.type === 'update_rating'){
            const list = document.querySelector('.ratings ul');
            list.innerHTML = '';
            (d.ratings || []).forEach(r => {
              const li = document.createElement('li');
              li.innerText = (r.team_name || r.session_key) + ' — ' + r.score;
              list.appendChild(li);
            });
          }
        }catch(err){console.error(err)}
      };
    })();
  </script>
</body>
</html>
